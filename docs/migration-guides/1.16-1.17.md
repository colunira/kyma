# Migrate from 1.15 to 1.16

## Istio

Kyma 1.17 comes with a new Istio version: 1.7.3. 

Make sure you cluster runs Kubernetes version 1.16 or higher.

Authenication Policy is no longer supported. Replace it with Peer Authentication and RequestAuthentication.

Additionally, this Istio version updates the CRD of the Virtual Service. The way of providing cross-origin resource sharing (CORS) configuration changes:

```bash
# Old way
allowOrigin:
  - "*"

# New way
allowOrigins:
  - regex: ".*"
```

To resolve the compability issues, we introduce a migration job which adds a new field to every Virtual Service on the cluster without deleting the previous configuration:

```bash
spec:
  http:
  - match:
    corsPolicy:
      allowOrigins:
        - regex: ".*"
```

After the upgrade, check if you have a custom Allowed Origins CORS configuration in your Virtual Services. You will have to migrate them manually. Run:

```bash
kubectl get vs --all-namespaces -o=go-template --template='{{ range .items }}{{ $name := .metadata.name}}{{ range $key, $value := .spec.http}}{{if $value.corsPolicy.allowOrigin }}{{ printf "%s : " $name }}{{ printf "%v\n" $value.corsPolicy.allowOrigin }}{{println ""}}{{ end }}{{ end }}{{ end }}'
```

The command returns a list of pairs consisting of Virtual Service name and allowed origins. Look for entries different than `{VS_NAME} : [*]` and migrate them manually to the [new version](https://istio.io/latest/docs/reference/config/networking/virtual-service/#CorsPolicy). You can find the old configuration under the key `spec.http.corsPolicy.allowOrigin`.
